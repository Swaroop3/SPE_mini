---
- name: Deploy scientific calculator container
  hosts: calculator_hosts
  vars:
    calculator_image: "{{ calculator_image | default('spe-calculator:latest') }}"
    calculator_container_name: "{{ calculator_container_name | default('scientific-calculator') }}"
    calculator_container_port: "{{ calculator_container_port | default(8000) }}"
    calculator_host_port: "{{ calculator_host_port | default(8000) }}"
    project_root: "{{ project_root | default(playbook_dir | dirname | dirname) }}"
    build_from_source: "{{ build_from_source | default(true) }}"
  pre_tasks:
    - name: Check Docker availability
      ansible.builtin.command: docker version
      register: docker_version
      changed_when: false
  tasks:
    - name: Ensure project root exists
      ansible.builtin.stat:
        path: "{{ project_root }}"
      register: project_root_stat

    - name: Abort when project root is missing
      ansible.builtin.fail:
        msg: "Project root {{ project_root }} does not exist. Override project_root if the repository lives elsewhere."
      when: not project_root_stat.stat.exists

    - name: Check for Dockerfile
      ansible.builtin.stat:
        path: "{{ project_root }}/Dockerfile"
      register: dockerfile_stat

    - name: Build image from local Dockerfile
      community.docker.docker_image:
        name: "{{ calculator_image }}"
        source: build
        build:
          path: "{{ project_root }}"
        push: false
      when:
        - dockerfile_stat.stat.exists
        - build_from_source | bool

    - name: Pull image from registry when Dockerfile missing
      community.docker.docker_image:
        name: "{{ calculator_image }}"
        source: pull
      when: not dockerfile_stat.stat.exists or not (build_from_source | bool)

    - name: Run scientific calculator container
      community.docker.docker_container:
        name: "{{ calculator_container_name }}"
        image: "{{ calculator_image }}"
        state: started
        recreate: true
        restart_policy: unless-stopped
        published_ports:
          - "{{ calculator_host_port }}:{{ calculator_container_port }}"
